## IMU



## 1. IMU

### 测量模型

https://zhuanlan.zhihu.com/p/38009126

在IMU内部，除了通常的白噪声，还有个特别的量零偏**bias**，在这是传感器内部机械、温度等各种物理因素产生的传感器内部误差的综合参数。IMU的加速度计和陀螺仪的每个轴都用彼此相互独立的参数建模，一个角速度测量值和真值之间的连续域上的关系可以写作：

![image-20210903075018481](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210903075018481.png)

IMU每个时刻可实现自身主体加速度$a$和角速度$w$的测量，有测量模型 式(1)：

![image-20210903074800349](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210903074800349.png)

### 运动模型

式(2)：

![image-20210903075114747](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210903075114747.png)

在区间$[t, t+\Delta t]$里有 式(3)：

![image-20210903075202338](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210903075202338.png)

将式1、2带入式3可得 式(4)：

![image-20210903075315906](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210903075315906.png)

从式4可以看到，IMU可以干的事情就是由上个时刻$t$状态可以推算出下个时刻$t+\Delta t$的状态， 这里的状态就是旋转角度R, 速度V和位置P。

### IMU 预积分的作用是什么？

用IMU的slam、vio算法有很多，有滤波器的比如**MSCKF**，有基于图优化的比如**VINS**，**OKVIS，ORB-SLAM**等。就拿**ORB-SLAM**来说吧， 在bundle adjustment里，参与对象是keyframe，比如有2个keyframe： $KF_1, KF_2$，他们的位姿分别为： $P_{1w}, P_{2w}$，那么他们的相对位姿 :

![image-20210903075655223](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210903075655223.png)

我们可以认为$P_{21}$为**估计项**，是由SLAM的位姿直接算出来的。如果要构成一个优化问题，我们还需要知道**误差项**和**测量项。**没错，是IMU可以计算在这两个KF间的**测量项** $P_{imu}$，预计分干的事情就是计算这个测量项。

![image-20210903075804403](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210903075804403.png)

在紧耦合的优化slam中，IMU就是提供了两个关键帧的相对测量，从而构建误差函数对关键帧姿态的迭代优化。当然实际应用中不会是这么简单的形式，这里面要对各个变量分别求取误差，然后求雅克比矩阵。

### IMU 预积分计算

#### $i \to j$：

根据两帧$k=i, k=j$之间的所有IMU测量，MU的每个时刻间的间隔是$\Delta t$，有$k=i$时刻的$R_i, V_i, p_i$直接更新得到$k=j$时刻的$R_j, V_j, p_j$ 式5：

![image-20210904072825757](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210904072825757.png)

其中$\Delta t_{ij}=\sum_{k=i}{j}\Delta t$，可以认为$R_i=R_{Wi}$标识$i$帧到世界坐标系$W$的旋转。

#### R、V、p增量：

而等式右侧都依赖于上一时刻的状态$R_i, V_i, p_i$，如果直接积分，每次计算下一帧的状态时，都需要从上一帧$i$的状态进行积分，造成计算复杂。于是，为了避免每次更新初始的 $R_i, V_i, p_i$都需要重头积分求解$R_j, V_j, p_j$，引出 **预积分项（理想值）**如下，$i \to j$的相对变化 式6：

![image-20210904073333969](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210904073333969.png)

这里有一个前提假设，就是我们认为零偏$b_i$是已知的，即：

![image-20210904073511787](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210904073511787.png)

从而计算$\Delta R_{ij}$时只需要IMU的数据就可以进行积分，而不依赖于上一状态，这就是预积分。但还有一个问题，式中小括号内都代表”真实变化量“，而我们拿到的都是测量值（上方代~号），需要去掉噪声和偏移的影响。

在**g2o**优化中，一般我们的KF的状态量是由5量构成，其中是： $R, V, P, b_a, b_g$， 所以加速度和角速度的零偏也是需要估计的，也就是说我们每优化一次Bias就要变化一次。 那么问题来了，难道我们没做一次**local bundle adjustment** 就需要重新再计算一遍 **式6** 吗？当然不需要，有方法来避免重复计算，我们只需要用新的Bias来更新一下预积分的值就行了。

#### 噪声传递：

对旋转增量$\Delta R_{ij}, \Delta V_{ij}, \Delta p_{ij}$进一步近似，根据上面偏移量不变，得到如下 式7：

![image-20210904074459770](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210904074459770.png)

上面得到的预积分理想值和测量值的关系如下：

![image-20210904074922308](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210904074922308.png)

代入预积分理想值的表达式：

![image-20210904075002922](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210904075002922.png)

则得到IMU预积分的误差模型 式8：

![image-20210904075040165](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210904075040165.png)

上述表达式为预积分测量值（含 IMU 测量值及 bias 估计值）与理想值之间的关系，即形如 “测量值=理想值’+’噪声”的形式（旋转量为乘性）。

#### 估计噪声：

下面对预积分测量噪声进行分析（目的是给出其协方差的计算表达式），需要估计噪声，噪声如何进行传递，从上一个的噪声，到下一时刻的噪声的表达式：

![image-20210904075632305](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210904075632305.png)



#### 偏移量更新：

再次强调，前面的预积分计算，都是在假设积分区间内陀螺和加计的 bias 恒定的基础上 推导的。

当 bias 发生变化时，若仍按照前述公式，预积分测量值需要整个重新计算一遍，计算量复杂度高。为了解决这个问题，提出了利用线性化来进行 bias 变化时预 积分项的一阶近似更新方法。下一时刻的偏移可以用上一时刻的偏移，与上一时刻的线性化增量（雅可比）进行表示，如果bias的更新：$b \leftarrow \bar b + \delta b$，上式8中的增量对bias进行一阶展开得到，即 式9：

![image-20210904080023342](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210904080023342.png)



左侧表示下一时刻的偏移$\hat b_j$，右侧表示上一时刻的偏移$\bar b_i$与线性化增量（雅可比，R, v, p对$\bar b^g, \bar b_a$的偏导）进行近似。具体的雅可比形式在邱博的文档给出了详细推导：

![image-20210904080535968](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210904080535968.png)

由此得到了偏移bias的变化。

#### 残差项：

残差指的是预积分计算值（由非 IMU 的其他方式猜测/估计的预积分值）与测量值的差别。

在进行 optimization 时，将对所有待优化的导航状态进行 lifting（可以理解为“更新”），从而影响预积分计算值和预积分测量值，进而改变残差值，optimization 的最终目的是要使残差（的加权范数）最小化。

获得预积分结果后，得到的是两个关键帧之间的旋转、速度、平移的约束，需要与视觉观测的结果做残差，得到残差项如下 式10：

![image-20210904080923052](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210904080923052.png)

![image-20210904081746579](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210904081746579.png)

#### 雅可比：

![image-20210904082210525](%E5%9B%BE%E8%A1%A8%E5%BA%93/image-20210904082210525.png)

迭代更新，使得残差项达到最小，即完成了IMU和视觉的融合。